# After.read<!--{{{-->

[Case Study: Grep Operator, Part One / Learn Vimscript the Hard Way](https://learnvimscriptthehardway.stevelosh.com/chapters/32.html)

[Qiita レジェンド達の偉大さをシェル芸で眺めて 2016 年を振り返る - Qiita](https://qiita.com/t_nakayama0714/items/776724410b2a119af088)

[達人プログラマーまとめ - Qiita](https://qiita.com/m-hatano/items/872c26106240e0e21e0f)

[シェルの変数展開 - Qiita](https://qiita.com/bsdhack/items/597eb7daee4a8b3276ba)

[シェルスクリプトを自己文章化する - Qiita](https://qiita.com/suttang/items/d4b4474e93c8e74ae515)

[シェルスクリプトを使って「これから毎日金相場をスクレイピングしようぜ？」という話 - Qiita](https://qiita.com/furandon_pig/items/80562f6adcce53baeb0a)

[POSIX 原理主義に基づく究極のスクレイピング - Qiita](https://qiita.com/richmikan@github/items/024b1f3869c84b9a3a21)

[環境に依存しないワンライナーを書くなら sed より perl の方がいい - Qiita](https://qiita.com/takc923/items/8654d69008e921c9c9fb)

[【sed / awk / grep】文字列の置換・抽出・検索と正規表現 | Linux Cheat Sheet - Qiita](https://qiita.com/shuntaro_tamura/items/e4e942e7186934fae5e7)

[](https://blog.riywo.com/2011/04/19/022802/)

[Part 1: GNU Parallel script processing and execution - YouTube](https://www.youtube.com/watch?v=OpaiGYxkSuQ)

[すぐ忘れてしまう、仕事で使う技 - Qiita](https://qiita.com/hana_shin/items/53c3c78525c9c758ae7c)

[Bash、ターミナル関連の面白い URL まとめ(?) - Qiita](https://qiita.com/Cj-bc/items/08210305a888fcb829af)

- [ ] learn-bash init <https://qiita.com/Ping/items/57fd75465dfada76e633>

[計算量オーダーの求め方を総整理！ 〜 どこから log が出て来るか 〜 - Qiita](https://qiita.com/drken/items/872ebc3a2b5caaa4a0d0)

hacker
<https://kyne.com.au/~mark/software/>
<https://nmap.org/book/install.html>
<https://github.com/ShellShoccar-jpn>
<https://github.com/ShellShoccar-jpn/blog/blob/master/20161221_mappingly_programming.md>
<https://github.com/usp-engineers-community/Open-usp-Tukubai>
<https://qiita.com/suin/items/22662f43b6a6e8728798>
<https://github.com/unokun/go-todo-api>

<!--}}}-->

# 04/09/21<!--{{{-->

- [redis-cli コマンド操作まとめ - Qiita](https://qiita.com/rubytomato@github/items/d66d932959d596876ab5)
- [EVAL – Redis](https://redis.io/commands/eval)
- <https://evolany.larksuite.com/docs/docusJzCisQ6M6wJEmErDDjMBTd>

- [x] redis-cli command
- [x] redis basics
- [x] redis expire
- [x] redis-usecase
- [x] redis lua function
- [x] redis tastcase

- [ ] try docker osx image
- [ ] try textimg
<!--}}}-->

# 04/10/21 # 04/10/22<!--{{{-->

- [x] closed mapping in vim.
- [x] closed filetype indent in vim.
- [x] map noh highlighting.
- [x] vim-anynight collect colors.
- [x] collect learn english phrase to documents.
- [x] session box github account switching.
- [x] hyperapp initialized to kis9a/kis9a.
- [x] bash boxes snippets -> -d stone -p a8v8
- [x] vim - how to snippets. -> coc-snippets
- [x] select slide tool. -> bash-slides.
- [x] buy ipad 11 pro screen paper like film
- [x] memos2json rewrite with golang and sepalate index content json.
- [x] map nvim toggle term lua <https://github.com/akinsho/nvim-toggleterm.lua>
- [ ] try hyperapp tutorial.
<!--}}}-->

## 2021-04-12<!--{{{-->

- [x] new entry and controllers/redis functions test
- [x] search gmail response with compare controllers/email get_code.
- [x] build development environment anybot-lua.
- [x] lua complex object to redis cache, what kind of cache and how.
<!--}}}-->

## 2021-04-13<!--{{{-->

- [x] get threads length by mysql query.
- [x] imac setup account check. > ../../memos/accounts.md
- [x] imac setup development environment setup.
- [x] vimium customize styles and colors.
- [x] hyperapp index search in kis9a/memos with state.
- [x] update kis9a/ and dotfiles/
<!--}}}-->

## 2021-04-14<!--{{{-->

- get_threads api

  - [x] Redis 1 : $bid:threads: jsonstring
  - [x] Redis 2 : $tid:threads: jsonstring
  - [x] get thread list length for pagenation
  - [x] if empty cache get by db, else get by redis
  - [x] get tables rows_length when bid is arg_bid.
  - [x] get bot.assignment by cid=thread_id.

- [ ] Q: where get assignment to each threads ?
- [ ] Q: how to confirm the threadlist change ?
- [ ] Q: how long keepalive time redis cache ?
<!--}}}-->

## 2021-04-16<!--{{{-->

- [x] how to merge https://affinity.help/
- [x] make calm background with kis9a icon for imac.
<!--}}}-->

## 2021-04-21<!--{{{-->

- [x] test redis pipeline init and commitations.
- [x] improve assignment get query in update redis function.
- [x] lua switch case snippet.
- [x] learn-lua lua manual 5.1 index function try string.

<!--}}}-->

## 2021-04-22

- [x] serial number php loop implementation.
- [x] serial number bash part zshuf.
- [ ] snippts replace snippets <https://github.com/honza/vim-snippets/blob/master/UltiSnips/markdown.snippets>
- [ ] serial number bash part Variable expansion fix.
- [ ] serial number create with luajit and sort out each language preformance.
- [ ] study how to bench mark arround all languages.
- [ ] serial number preformance with time command.
- [ ] learn-lua lua manual 5.1 index function try os.
- [ ] read and memorize how to make secure web site.
- [ ] mdl snippets option to html tag
- [ ] youtube sort out playlists.
- [ ] posix regex

## 2021-04-26

- [ ] error error_handling improvement
- [ ] consistency function in db.lua
- [ ] usage test function clearn
- [ ] function の粒度と要件

<!-- - [ ] -->
<!-- - [ ] service worker -->

<https://github.com/nesbox/TIC-80>
<https://qiita.com/umisama/items/2f1ae3a90b9a07196f68>
<http://lua-users.org/wiki/LuaCarp>
<https://rhysd.hatenablog.com/entry/2018/12/23/235933>

# 2021-04-16<!--{{{-->

- [x] how to merge https://affinity.help/
- [x] make calm background with kis9a icon for imac.
<!--}}}-->

## Box<!--{{{-->

- [ ] add memorizing to kis9a.github.io/kis9a.
- [ ] hard to vimscript<https://learnvimscriptthehardway.stevelosh.com/>
- [ ] add articles to zenn.
- [ ] anynight lp scheme.
- [ ] anynight vim color scheme.
- [ ] invite keito to anynight.
- [ ] hyperapp code reading - what, how to vdom.
- [ ] hyperapp code reading - what, how to interface.
- [ ] static analysis collect sources. pup markdown2\*...

- [ ] script lolstr figlet -f --- | boxes -d stone -p a8v8(row,height) | lolcat & sleep and tput clear
- [ ] study how to slide with bash script.
<!--}}}-->

hacker
<https://kyne.com.au/~mark/software/>
<https://nmap.org/book/install.html>
<https://github.com/ShellShoccar-jpn>
<https://github.com/ShellShoccar-jpn/blog/blob/master/20161221_mappingly_programming.md>
<https://github.com/usp-engineers-community/Open-usp-Tukubai>
<https://qiita.com/suin/items/22662f43b6a6e8728798>
<https://github.com/unokun/go-todo-api>

```
function keygen(len, chars)
    len = len or 16
    chars = empty(chars) and 'abcdefghijklmnopqrstuvwxyz0123456789_.;,-$%()!@' or chars
    local key = ''
    local clen = #chars
    for i=0,len do
        local x = math.random(clen)
		key = key..chars(x,x)
    end
	return #key == len and key or key:sub(1,len)
end


function! s:cnl()
  let line = line(".")
  let path = execute("echo expand('%:p')")
  let dir = system("dirname " . "'" . path . "'")
  if executable('git')
    let cmd = "( cd " . dir . "; git blame -L " . line . "," . line . " '" . path . "' )"
    " echo cmd
    echo substitute(cmd, "\n$", '', '')
    let blamestr = system(cmd)
    " echo blamestr
  endif
endfunction

nnoremap <silent> <Leader>c :call <SID>cnl()<CR>
```

# 2021-04-23

- [ ] mysql transaction study and how to in lua.

```
START TRANSACTION;
update test_db_transaction_lua set name="new name" where name="one";
select * from test_db_transaction_lua;
COMMIT;

START TRANSACTION;
update test_db_transaction_lua set name="newname" where name="one";
INSERT INTO test_db_transaction_lua (name) VALUES ("four");
update test_db_transaction_lua set name="one" where name="newname";
COMMIT;
select * from test_db_transaction_lua;

START TRANSACTION;
INSERT INTO test_db_transaction_lua (name) VALUES ("four");
COMMIT;




START TRANSACTION;

update test_db_transaction_lua set name = case when name="one" then "newname" else "one" end where id=1;

INSERT INTO test_db_transaction_lua (name) VALUES ("four");

COMMIT;

update test_db_transaction_lua set name = case when name="one" then "newname" else "one" end where id=1;

update test_db_transaction_lua set name="newname" where name="one";

update test_db_transaction_lua set name = if name = "one" then "newname" else "one" end if


```

		local tr = function ()--{{{
		-- 	local sqls = {
		-- 		"select * from test_db_transaction_lua",
		-- 		"update test_db_transaction_lua set name = case when name='one' then 'newname' else 'one' end where id=1",
		-- 		"update test_db_transaction_lua set name = case when name='two' then 'newtwoname' else 'two' end where id=2"
		-- 	}
			db:query("START TRANSACTION")
			local _, err = db:query("select * from test_db_transaction_lua")
			if not empty(err) then error("db query error") end
			local _, err = db:query("update test_db_transaction_lua set name = case when name='one' then 'newname' else 'one' end where id=1")
			if not empty(err) then error("db query error") end
			local _, err = db:query("update test_db_transaction_lua set name = case when name='two' then 'newtwoname' else 'two' end where id=2")
			if not empty(err) then error("db query error") end
		end--}}}
		-- local trn = function ()--{{{
		-- 	local value = "sample value"
		-- 	local sqls = {
		-- 		"select * from test_db_transaction_lua",
		-- 		"update test_db_transaction_lua set name = case when name='one' then 'newname' else 'one' end where id=1",
		-- 		"update test_db_transaction_lua set name = case when name='two' then 'newtwoname' else 'two' end where id=2"
		-- 	}
		-- 	for _, sql in ipairs(sqls) do
		-- 		local _, err = db:query(sql)
		-- 		if not empty(err) then error("db query error") end
		-- 	end

		-- 	local after_funcion = function ()
		-- 		ngx.say("after")
		-- 	end

		-- 	local sql_objs = {
		-- 		{
		-- 			str = "select * from test_db_transaction_lua",
		-- 		},
		-- 		{
		-- 			args = { id = 1, name = "one" },
		-- 			str = function (args)
		-- 				return S("update test_db_transaction_lua set name = case when name='", args.name, "' then 'newname' else 'one' end where id=", args.id)
		-- 			end,
		-- 			after = after_funcion()
		-- 		},
		-- 		{
		-- 			str = "update test_db_transaction_lua set name = case when name='two' then 'newtwoname' else 'two' end where id=2"
		-- 		}

		-- 	}
		-- end--}}}


MySQL Transaction in lua.

need any feedback and usecase to improve. pls.

```lua:anybot-lua/modules/db.lua
function db_trans(schema, q, conn)
	local is_suc = false
	local db = conn or db_conn(schema, true)
	if empty(db) then return end
	db:query("START TRANSACTION")

	local end_trans = function (is_commit)
		if is_commit then
			local res, err = db:query("COMMIT")
			db:set_keepalive(conf.db_keepalive, conf.db_poolsize)
			return res, err, is_suc
		else
			local res, err = db:query("ROLLBACK")
			return res, err, is_suc or false
		end
	end

	local sql_chain = function ()
		for _, sql in ipairs(q) do
			if is_str(sql) then
				local _, err = db_query(schema, sql)
				if not empty(err) then error("database error"); return; end
			end
			-- TODO?: if is_table(sql) then any option actions.
		end
	end

	is_suc = is_func(q) and pcall(q) or is_array(q) and pcall(sql_chain) or false
	local res, err, is_success =  end_trans(is_suc)
	return res, err, is_success
end
```

check: http://localhost:8000/test/db/trans_sqls

```lua:anybot-lua/test/db.lua
	-- TRANSACTION TEST DB SETUP {{{
		-- DROP TABLE test_db_transaction_lua;

		-- CREATE TABLE IF NOT EXISTS test_db_transaction_lua (
		--     id BIGINT(20) AUTO_INCREMENT NOT NULL PRIMARY KEY,
		--     name VARCHAR(255) NOT NULL,
		--     ins_t TIMESTAMP DEFAULT CURRENT_TIMESTAMP
		-- )  ENGINE=INNODB;

		-- INSERT INTO test_db_transaction_lua (name) VALUES ("one");
		-- INSERT INTO test_db_transaction_lua (name) VALUES ("two");
	-- }}}

	trans_sqls = function ()
		local q = {
			"select * from test_db_transaction_lua",
			"update test_db_transaction_lua set name = case when name='one' then 'new_one' else 'one' end where id=1",
			S("update test_db_transaction_lua set name = case when name='two' then 'new_two' else 'two' end where id=", 2),
		}

		local res, err, is_suc = db_trans("master", q)
		local rs = db_query("master", "select name from test_db_transaction_lua where id = 1 or id = 2")
    ngx.say("is_suc: ", is_suc)
		ngx.say("err: ", err)
		ngx.say(json_encode(rs))
		dump(res)
	end,

	trans_func = function ()
		local schema = "master"
		local conn = db_conn(schema, false) -- you can declaration before db_trans as 3rd argument.
		local tra = function ()
			local res, err = db_query(schema, "select * from test_db_transaction_lua")
			if not empty(err) then error("database error"); ngx.say("not empty"); return; end -- you have to check error each query.
			ngx.say(json_encode(res), "\n-- the case: use function, when you want to use db response\n")

			local res2, err2 = db_query(schema, "update test_db_transaction_lua set name = case when name='one' then 'new_one' else 'one' end where id=1")
			if not empty(err2) then error("database error"); return; end -- you have to check error each query.

			local _, err3 = db_query(schema, "update test_db_transaction_lua set name = case when name='two' then 'new_two' else 'two' end where id=2")
			if not empty(err3) then error("database error"); return; end -- you have to check error each query.
		end
		local res, err, is_suc = db_trans(schema, tra, conn)
		local rs = db_query("master", "select name from test_db_transaction_lua where id = 1 or id = 2")
    ngx.say("is_suc: ", is_suc)
		ngx.say("err: ", err)
		ngx.say(json_encode(rs))
		dump(res)
	end,
}
```

check: http://localhost:8000/test/db/trans_func
